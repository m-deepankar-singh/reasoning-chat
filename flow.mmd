graph TD
    subgraph Configuration
        Config[Config Class]
        Config -->|Validates| EnvVars[Environment Variables]
        Config -->|Creates| Directories[Directory Structure]
    end

    subgraph Core Services
        ModelManager[Model Manager]
        DatabaseManager[Database Manager]
        DocumentStore[Document Store]
        FallbackHandler[Fallback Handler]
    end

    subgraph External Services
        DeepseekAPI[Deepseek API]
        GeminiAPI[Google Gemini API]
        SerpAPI[SerpAPI Search]
        LocalLLM[Local Llama Model]
    end

    subgraph Document Processing Pipeline
        DocProcessor[Document Processor]
        subgraph Processors
            PDFProc[PDF Processor]
            DOCXProc[DOCX Processor]
            TXTProc[Text Processor]
        end
        MarkdownConverter[Markdown Converter]
        ContentHandler[Content Handler]
    end

    subgraph Processing Logic
        ContentLength{Content Length > 45k?}
        HasImages{Has Images?}
        ReasoningEnabled{Reasoning Enabled?}
        APIAvailable{Deepseek Available?}
    end

    subgraph Reasoning Engine
        ReasoningEngine[Reasoning Engine]
        subgraph Models
            GeminiThinking[Gemini Thinking]
            GeminiFlash[Gemini Flash]
            DeepseekReasoner[Deepseek Reasoner]
        end
    end

    subgraph API Endpoints
        ChatEndpoint[/Chat Endpoint/]
        DocEndpoint[/Document Endpoint/]
        GenEndpoint[/Generate Endpoint/]
        ConvEndpoint[/Conversation Endpoint/]
    end

    subgraph State Management
        Conversation[Conversation Manager]
        DB[(SQLite Database)]
        FileStore[File Storage]
    end

    %% Core Service Connections
    ModelManager --> LocalLLM
    ModelManager --> DeepseekAPI
    ModelManager --> GeminiAPI
    DatabaseManager --> DB

    %% Document Processing Flow
    DocEndpoint --> DocProcessor
    DocProcessor --> PDFProc & DOCXProc & TXTProc
    PDFProc & DOCXProc & TXTProc --> MarkdownConverter
    MarkdownConverter --> ContentLength

    %% Content Processing Logic
    ContentLength -->|Yes| GeminiThinking
    ContentLength -->|No| HasImages
    HasImages -->|Yes| ReasoningEnabled
    HasImages -->|No| APIAvailable
    
    ReasoningEnabled -->|Yes| GeminiThinking
    ReasoningEnabled -->|No| GeminiFlash
    
    APIAvailable -->|Yes| DeepseekReasoner
    APIAvailable -->|No| FallbackHandler
    
    %% Chat Flow
    ChatEndpoint --> Conversation
    Conversation --> ContentHandler
    ContentHandler --> ContentLength
    Conversation -->|Search| SerpAPI
    
    %% Data Storage
    DocProcessor --> FileStore
    Conversation --> DB
    
    %% Fallback Paths
    FallbackHandler -->|Reasoning| GeminiThinking
    FallbackHandler -->|Standard| GeminiFlash
    
    %% Final Processing
    ReasoningEngine --> LocalLLM
    
    style Config fill:#f9f,stroke:#333,stroke-width:2px
    style ModelManager fill:#f9f,stroke:#333,stroke-width:2px
    style DatabaseManager fill:#f9f,stroke:#333,stroke-width:2px
    style ReasoningEngine fill:#fcf,stroke:#333,stroke-width:2px
    style LocalLLM fill:#cfc,stroke:#333,stroke-width:2px
    style DB fill:#9cf,stroke:#333,stroke-width:2px
    style ContentLength fill:#ff9,stroke:#333,stroke-width:2px
    style HasImages fill:#ff9,stroke:#333,stroke-width:2px
    style ReasoningEnabled fill:#ff9,stroke:#333,stroke-width:2px
    style APIAvailable fill:#ff9,stroke:#333,stroke-width:2px